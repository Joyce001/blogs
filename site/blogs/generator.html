<!DOCTYPE html><html><head><meta charset="utf8"><title>yibuyisheng's blogs</title><style>.hljs, code[class^="lang-"] {
  display: block;
  overflow-x: auto;
  padding: 0.5em;
  background: #fbebd4;
  color: #839496;
  -webkit-text-size-adjust: none;
}

.hljs-comment,
.diff .hljs-header,
.hljs-doctype,
.hljs-pi,
.lisp .hljs-string {
  color: #586e75;
}

/* Solarized Green */
.hljs-keyword,
.hljs-winutils,
.method,
.hljs-addition,
.css .hljs-tag,
.hljs-request,
.hljs-status,
.nginx .hljs-title {
  color: #859900;
}

/* Solarized Cyan */
.hljs-number,
.hljs-command,
.hljs-string,
.hljs-tag .hljs-value,
.hljs-rule .hljs-value,
.hljs-doctag,
.tex .hljs-formula,
.hljs-regexp,
.hljs-hexcolor,
.hljs-link_url {
  color: #2aa198;
}

/* Solarized Blue */
.hljs-title,
.hljs-localvars,
.hljs-chunk,
.hljs-decorator,
.hljs-built_in,
.hljs-identifier,
.vhdl .hljs-literal,
.hljs-id,
.css .hljs-function,
.hljs-name {
  color: #268bd2;
}

/* Solarized Yellow */
.hljs-attribute,
.hljs-variable,
.lisp .hljs-body,
.smalltalk .hljs-number,
.hljs-constant,
.hljs-class .hljs-title,
.hljs-parent,
.hljs-type,
.hljs-link_reference {
  color: #b58900;
}

/* Solarized Orange */
.hljs-preprocessor,
.hljs-preprocessor .hljs-keyword,
.hljs-pragma,
.hljs-shebang,
.hljs-symbol,
.hljs-symbol .hljs-string,
.diff .hljs-change,
.hljs-special,
.hljs-attr_selector,
.hljs-subst,
.hljs-cdata,
.css .hljs-pseudo,
.hljs-header {
  color: #cb4b16;
}

/* Solarized Red */
.hljs-deletion,
.hljs-important {
  color: #dc322f;
}

/* Solarized Violet */
.hljs-link_label {
  color: #6c71c4;
}

.tex .hljs-formula {
  background: #073642;
}

</style><style type="text/css">body {
    background: #fdf6e3;
    font-family: Georgia, serif;
}
.container {
    display: flex;
}
.nav {
    margin-right: 20px;
    min-width: 240px;
}
.nav a {
    color: #556677;
    text-decoration: none;
}
.nav h5 {
    margin: 0;
    line-height: 35px;
    font-size: 14px;
}
.content {
    flex: 1;
    line-height: 1.4em;
}
.content img {
    max-width: 100%;
}
</style><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?975a5aad9775f4e01af87fb7c67b8f63";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();</script></head><body><div class="container"><div class="nav"><h3><a href="/blogs/site/index.html">首页</a></h3><h5><a href="/blogs/site/blogs/CSS border-image.html">CSS border-image</a></h5><h5><a href="/blogs/site/blogs/CSS border-radius.html">CSS border-radius</a></h5><h5><a href="/blogs/site/blogs/使用 CSS background 构造一个棋盘.html">使用 CSS background 构造一个棋盘</a></h5><h5><a href="/blogs/site/blogs/generator.html">generator</a></h5><h5><a href="/blogs/site/blogs/百度 EFE 前端框架学习笔记（ef）.html">百度 EFE 前端框架学习笔记（ef）</a></h5><h5><a href="/blogs/site/blogs/百度 EFE 前端框架学习笔记（esui）.html">百度 EFE 前端框架学习笔记（esui）</a></h5><h5><a href="/blogs/site/blogs/百度 EFE 前端框架学习笔记（er）.html">百度 EFE 前端框架学习笔记（er）</a></h5><h5><a href="/blogs/site/blogs/Reflux 使用进化日记.html">Reflux 使用进化日记</a></h5><h5><a href="/blogs/site/blogs/记一次坑爹的对接经历.html">记一次坑爹的对接经历</a></h5></div><div class="content"><!-- config.time: 2015-07-13 -->
<h1 id="generator">generator</h1>
<h3 id="-generator-">什么是 generator ？</h3>
<p>可以暂停（ pause ）和唤醒（ resume ）的函数。</p>
<h3 id="-">实现一个迭代器</h3>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">gen</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">for</span> <span class="hljs-params">(let a of [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])</span> {
        yield a + <span class="hljs-number">1</span>;
    }

    return <span class="hljs-number">5</span>;
}

<span class="hljs-comment">// 下面的 for 循环输出：</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
<span class="hljs-keyword">for</span> <span class="hljs-params">(let b of gen<span class="hljs-params">()</span>)</span> {
    print<span class="hljs-params">(JSON.stringify<span class="hljs-params">(b)</span>)</span>;
}

<span class="hljs-built_in">let</span> it = gen<span class="hljs-params">()</span>;
print<span class="hljs-params">(JSON.stringify<span class="hljs-params">(it.next<span class="hljs-params">()</span>)</span>)</span>; <span class="hljs-comment">// 输出： {value: 2, done: false}</span>
print<span class="hljs-params">(JSON.stringify<span class="hljs-params">(it.next<span class="hljs-params">()</span>)</span>)</span>; <span class="hljs-comment">// 输出： {value: 3, done: false}</span>
print<span class="hljs-params">(JSON.stringify<span class="hljs-params">(it.next<span class="hljs-params">()</span>)</span>)</span>; <span class="hljs-comment">// 输出： {value: 4, done: false}</span>
print<span class="hljs-params">(JSON.stringify<span class="hljs-params">(it.next<span class="hljs-params">()</span>)</span>)</span>; <span class="hljs-comment">// 输出： {value: 5, done: true}</span>

print<span class="hljs-params">(JSON.stringify<span class="hljs-params">([...gen<span class="hljs-params">()</span>])</span>)</span>; <span class="hljs-comment">// 输出： [2, 3, 4]</span>
</code></pre>
<h3 id="-generator-">创建 generator 的方式</h3>
<pre><code class="lang-js"><span class="hljs-comment">// 第一种</span>
<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">genFunc</span><span class="hljs-params">()</span> {</span> ··· }
<span class="hljs-built_in">let</span> genObj = genFunc<span class="hljs-params">()</span>;

<span class="hljs-comment">// 第二种</span>
const genFunc = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-params">()</span> {</span> ··· };
<span class="hljs-built_in">let</span> genObj = genFunc<span class="hljs-params">()</span>;

<span class="hljs-comment">// 第三种</span>
<span class="hljs-built_in">let</span> obj = {
    <span class="hljs-built_in">*</span> generatorMethod<span class="hljs-params">()</span> {
        ···
    }
};
<span class="hljs-built_in">let</span> genObj = obj.generatorMethod<span class="hljs-params">()</span>;

<span class="hljs-comment">// 第四种</span>
class MyClass {
    <span class="hljs-built_in">*</span> generatorMethod<span class="hljs-params">()</span> {
        ···
    }
}
<span class="hljs-built_in">let</span> myInst = new MyClass<span class="hljs-params">()</span>;
<span class="hljs-built_in">let</span> genObj = myInst.generatorMethod<span class="hljs-params">()</span>;
</code></pre>
<h3 id="generator-yield-">generator 嵌套： yield*</h3>
<pre><code class="lang-js">function* gen1() {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
    <span class="hljs-keyword">return</span> '<span class="hljs-literal">result</span> <span class="hljs-keyword">of</span> gen1';
}
function* gen2() {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;

    // `<span class="hljs-keyword">yield</span>* gen1()` 类似于
    // <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x <span class="hljs-keyword">of</span> gen1()) {
    //      <span class="hljs-keyword">yield</span> x;
    // }
    print(<span class="hljs-type">JSON</span>.stringify(<span class="hljs-keyword">yield</span>* gen1()));

    <span class="hljs-keyword">yield</span> <span class="hljs-number">4</span>;
}
// 输出：
// '<span class="hljs-literal">result</span> <span class="hljs-keyword">of</span> gen1'
// [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
print(<span class="hljs-type">JSON</span>.stringify([...gen2()]));

function* gen3() {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">yield</span>* [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
    <span class="hljs-keyword">yield</span> <span class="hljs-number">4</span>;
}
print(<span class="hljs-type">JSON</span>.stringify([...gen3()])); // 输出： [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
</code></pre>
<h3 id="next-">next 传值</h3>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">gen1</span><span class="hljs-params">()</span> {</span>
    print<span class="hljs-params">(JSON.stringify<span class="hljs-params">(yield)</span>)</span>;
}
<span class="hljs-built_in">let</span> it = gen1<span class="hljs-params">()</span>;
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// {value: undefined, done: false}</span>
<span class="hljs-comment">// outer value</span>
<span class="hljs-comment">// {value: undefined, done: true}</span>
print<span class="hljs-params">(JSON.stringify<span class="hljs-params">(it.next<span class="hljs-params">()</span>)</span>)</span>;
print<span class="hljs-params">(JSON.stringify<span class="hljs-params">(it.next<span class="hljs-params">('outer value')</span>)</span>)</span>;
</code></pre>
<h3 id="-return-generator"><code>return()</code> 外部终止 generator</h3>
<pre><code class="lang-js">function* gen1() {
    print('a');
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
    print('b');
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
    print('c');
}
// 输出：
// a
// {value: <span class="hljs-number">1</span>, done: <span class="hljs-literal">false</span>}
// {value: '<span class="hljs-literal">result</span>', done: <span class="hljs-literal">true</span>}
<span class="hljs-keyword">let</span> it = gen1();
print(<span class="hljs-type">JSON</span>.stringify(it.next()));
print(<span class="hljs-type">JSON</span>.stringify(it.<span class="hljs-keyword">return</span>('<span class="hljs-literal">result</span>')));
</code></pre>
<h3 id="-throw-"><code>throw()</code> 抛出异常</h3>
<pre><code class="lang-js">function* gen() {
    <span class="hljs-keyword">try</span> {
        print('<span class="hljs-type">Started</span>');
        <span class="hljs-keyword">yield</span>;
    } catch (error) {
        print('<span class="hljs-type">Caught</span>: ' + error.message);
    }
    <span class="hljs-keyword">return</span> '<span class="hljs-keyword">return</span> <span class="hljs-literal">result</span>';
}
// 输出：
// <span class="hljs-type">Started</span>
// {value: undefined, done: <span class="hljs-literal">false</span>}
// <span class="hljs-type">Caught</span>: error
// {value: '<span class="hljs-keyword">return</span> <span class="hljs-literal">result</span>', done: <span class="hljs-literal">true</span>}
<span class="hljs-keyword">let</span> it = gen();
print(<span class="hljs-type">JSON</span>.stringify(it.next()));
print(<span class="hljs-type">JSON</span>.stringify(it.throw(new <span class="hljs-type">Error</span>('error'))));
</code></pre>
<h3 id="-">很有有趣也有用的例子</h3>
<pre><code class="lang-js"><span class="hljs-comment">// for 循环延迟执行</span>
<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">fn1</span>(<span class="hljs-params">iterable</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x <span class="hljs-keyword">of</span> iterable) {
        <span class="hljs-keyword">if</span> (x === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">yield</span> x;
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">fn2</span>(<span class="hljs-params">iterable</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x <span class="hljs-keyword">of</span> iterable) {
        <span class="hljs-keyword">yield</span> x + <span class="hljs-number">1</span>;
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">fn3</span>(<span class="hljs-params">iterable</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x <span class="hljs-keyword">of</span> iterable) {
        <span class="hljs-keyword">yield</span> x / <span class="hljs-number">2</span>;
    }
}
<span class="hljs-keyword">let</span> newArr = [...fn3(fn2(fn1([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])))];
print(<span class="hljs-built_in">JSON</span>.stringify(newArr)); <span class="hljs-comment">// [1, 1.5, 2]</span>
</code></pre>
<h3 id="generator-">generator 类图</h3>
<p>规范里面有一张<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-generatorfunction-objects">很大的图</a>，有点复杂。所以，看一张小图：</p>
<p><img src="https://github.com/yibuyisheng/blogs/blob/master/imgs/5.jpg" alt=""></p>
<p>说明：</p>
<ul>
<li>空心箭头表示两个对象的继承关系。换句话说，从 x 指向 y 的箭头意味着 <code>Object.getPrototypeOf(x) === y</code> 。</li>
<li>圆括号表示当前被包起来的对象是存在的，但是不能通过全局变量来访问。</li>
<li>带有 <code>instanceof</code> 字眼的箭头如果从 x 指向 y ，就表明 <code>x instanceof y</code> 。<ul>
<li><code>o instanceof C</code> 实际上就相当于 <code>C.prototype.isPrototypeOf(o)</code></li>
</ul>
</li>
<li>带有 <code>prototype</code> 字眼的箭头如果从 x 指向 y ，就表明 <code>x.prototype === y</code> 。</li>
</ul>
<p>此图看完可能没有直观的感受，看两个例子先。</p>
<p>第一个， generator 函数表现得很像一个构造函数，因为通过 <code>new</code> 调用和直接调用，两者的效果是一样的，都返回 generator 对象，如下所示：</p>
<pre><code>&gt; <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">g</span>(<span class="hljs-params"></span>) </span>{}
&gt; g.prototype.hello = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">'hi!'</span>};
&gt; <span class="hljs-keyword">let</span> obj = g();
&gt; obj <span class="hljs-keyword">instanceof</span> g
<span class="hljs-literal">true</span>
&gt; obj.hello()
<span class="hljs-string">'hi!'</span>
</code></pre><p>第二个，如果想给所有的 generator 对象添加一个方法，就可以放在 <code>(Generator).prototype</code> 上面，如下所示：</p>
<pre><code>&gt; <span class="hljs-keyword">let</span> Generator_prototype = <span class="hljs-built_in">Object</span>.getPrototypeOf(<span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params"></span>) </span>{}).prototype;
&gt; Generator_prototype.hello = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">'hi!'</span>};
&gt; <span class="hljs-keyword">let</span> generatorObject = (<span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params"></span>) </span>{})();
&gt; generatorObject.hello()
<span class="hljs-string">'hi!'</span>
</code></pre><p>generator 内部的 <code>this</code> 是有一些猫腻的：</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">gen1</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-pi">    'use strict'</span>; <span class="hljs-comment">// just in case</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">this</span>;
}

<span class="hljs-comment">// Retrieve the yielded value via destructuring</span>
<span class="hljs-keyword">let</span> [functionThis] = gen1();
<span class="hljs-built_in">console</span>.log(functionThis); <span class="hljs-comment">// undefined</span>

<span class="hljs-keyword">let</span> obj = { method: gen1 };
<span class="hljs-keyword">let</span> [methodThis] = obj.method();
<span class="hljs-built_in">console</span>.log(methodThis === obj); <span class="hljs-comment">// true</span>

<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">gen2</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>); <span class="hljs-comment">// ReferenceError</span>
}
<span class="hljs-keyword">new</span> gen2();
</code></pre>
<h3 id="-tj-co-">一个简单的类似于 tj co 库的东西</h3>
<pre><code class="lang-js">// 此段代码使用 node --harmony 执行
executeGeneratorFn(function* () {
    <span class="hljs-keyword">var</span> <span class="hljs-literal">result</span> = <span class="hljs-keyword">yield</span> request.<span class="hljs-keyword">bind</span>(null, 'http://www.baidu.com', {userId: <span class="hljs-number">1</span>});
    console.log(<span class="hljs-literal">result</span>);
});

executeGeneratorFn(function* () {
    <span class="hljs-keyword">var</span> userList = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> param <span class="hljs-keyword">of</span> [{userId: <span class="hljs-number">1</span>}, {userId: <span class="hljs-number">2</span>}]) {
        userList.push(<span class="hljs-keyword">yield</span> request.<span class="hljs-keyword">bind</span>(null, 'http://www.baidu.com', param));
    }
    console.log(userList);
});

function request(url, params, callback) {
    setTimeout(() =&gt; callback('request <span class="hljs-literal">result</span>: ' + <span class="hljs-type">Math</span>.random()), <span class="hljs-number">3000</span>);
}

function executeGeneratorFn(genFn, callback) {
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">iterator</span> = genFn();
    next();

    function next() {
        <span class="hljs-keyword">try</span> {
            execute(<span class="hljs-keyword">iterator</span>.next(arguments));
        } catch (e) {
            callback instanceof <span class="hljs-type">Function</span> &amp;&amp; callback(e);
        }
    }

    function execute(nextValue) {
        <span class="hljs-keyword">if</span> (!nextValue.done) {
            nextValue.value(next);
        } <span class="hljs-keyword">else</span> {
            callback instanceof <span class="hljs-type">Function</span> &amp;&amp; callback(null, nextValue.value);
        }
    }
}
</code></pre>
<div id="disqus_thread" class="container"></div></div></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'yibuyisheng';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><a href="http://disqus.com" class="dsq-brlink"></a>blog comments powered by</noscript><span class="logo-disqus"></span></body></html>